ROADMAP Проекта "Take Your Profit 2.0" (Версия 4.0, "Золотой Эталон")
Часть 1: Архитектурная Философия
Мы создаем единый, адаптивный торговый организм, который функционирует на основе контекста, задаваемого "Движком Режимов Рынка". Логический поток принятия решений строго иерархичен и следует принципам "Risk-First" и "Контекстная Адаптивность".
Часть 2: Детализация Функциональных Блоков MVP
Блок 1: Regime Engine (Движок Режимов Рынка)
Задача: Быть главным "синоптиком", который сообщает всем остальным модулям, какая "погода" сейчас на рынке, позволяя использовать правильную тактику в правильное время.
Полный Функционал:
Три Режима Рынка:
Режим 1: TREND (Тренд / Импульс):
Условия: Рынок демонстрирует сильное, направленное движение.
Индикаторы-триггеры: ADX(14) на H1 > 22 (и растет) И Choppiness Index на H1 < 38 И ATR(14) на H1 в верхнем квантиле (> 60-го перцентиля).
Сценарий поведения ЕА: Активируются дневные трендовые стратегии (DualMA Anchor). Resolver отдает им высший приоритет. Разрешены доливки. Флэтовые сигналы (Night MR) полностью блокируются.
Режим 2: FLAT (Флэт / "Пила"):
Условия: Рынок движется в узком боковом диапазоне.
Индикаторы-триггеры: ADX(14) на H1 < 18 И Choppiness Index на H1 > 62 И ATR(14) на H1 в нижнем квантиле.
Сценарий поведения ЕА: Блокируются все трендовые стратегии. Активируются флэтовые профили (Night MR, "Три Экрана для Флэта"), которым разрешается работать и днем. Управление позицией консервативное (быстрый БУ, короткие ТП, доливки запрещены).
Режим 3: NORMAL (Нормальный / Переходный):
Условия: Все, что не является явным трендом или флэтом.
Индикаторы-триггеры: Промежуточные значения ADX (18-22) и Choppiness Index (38-62).
Сценарий поведения ЕА: Resolver рассматривает все типы сигналов, но требует для них более высокого score. Управление риском стандартное.
Гистерезис ("Липкость" Режимов):
Логика: Для перехода из одного режима в другой нужно, чтобы условия для нового режима сохранялись в течение 3-5 баров H1 подряд.
Обоснование: Защищает от "дёргания" между режимами и преждевременного выхода из трендовой сделки на первой же небольшой консолидации.
Блок 2: "Фундамент Безопасности" (Гварды)
Задача: Обеспечить многоуровневую, неотключаемую систему защиты, которая гарантирует выживаемость советника. Это наш "пассивный" источник альфы.
Компонент: Portfolio Risk Manager — наш центральный банк и служба безопасности.
Полный Функционал:
EquityGuard с сессионным Kill-switch: При достижении дневной просадки отключает только тот "бакет" (профиль), который активен, до конца его сессии.
DailyDDCap: Жесткий дневной лимит убытка.
CurrencyExposureCap: Жесткий лимит на количество одновременно открытых позиций с одной и той же базовой валютой (например, не более 2 сделок с AUD).
CooldownAllow: "Тайм-аут" на открытие новой сделки по тому же инструменту в течение N минут после закрытия предыдущей.
SequenceRisk: Логика контролируемой эскалации лота (до 5 попыток) при торговле у SMA 500, в рамках ограниченного "бюджета" на серию.
Автолот: Расчет лота на основе риска в % от депозита и динамической дистанции до стоп-лосса.
Компонент: ExecGate (Фильтры Исполнения) — наш "фейс-контроль" на входе.
Полный Функционал:
NewsGuard (Страж Новостей): Блокирует торговлю в окне до/после новостей (CSV / MT5 Calendar) с фильтрацией по важности/валютам/словам. Для супер-событий может принудительно закрывать позиции (Flatten).
QSpreadGuard (Квантильный Страж Спреда): Блокирует торговлю, если текущий спред превышает 80-й перцентиль исторического спреда для данного часа/инструмента. Защищает от аномальных расширений спреда, не мешая торговать, когда высокий спред — норма.
QVolatilityGate (Квантильный Страж Волатильности): Блокирует торговлю, если волатильность (ATR%) выходит за пределы коридора 20-80 перцентилей. Отсеивает "мертвые" и "штормовые" рынки.
MinSpace: Проверка "пространства" до ближайшего барьера (сильные МА, Фибо, уровни).
NoChase и TimeStop: Логика "не догонять цену" и закрытия "зависших" сделок.
ParentalLock: "Железная" блокировка любого ручного вмешательства.
Блок 3: "Ночной Профиль" (Торговля во Флэте)
Задача: Создать один, но исключительно сильный и надежный источник прибыли, работающий в условиях низкой волатильности.
Полный Функционал:
"Динамический Режим Охоты" (IsInHuntingZone):
Логика: Профиль активен только когда "Индекс Спокойствия" (VIX, ADR, ATR H1, ADX H1) подтверждает флэт.
Обоснование: Позволяет автоматически находить периоды консолидации не только ночью, но и днем.
Стратегия Night MR (Тип: "Сигнал Конфлюэнса", score > 80):
Принцип: Вход только при наборе очков из нескольких независимых источников, что кардинально повышает winrate.
"Якорь" (+25 очков): Касание второй границы канала Боллинджера на M15.
Подтверждения:
Slope Veto (Обязательно): Наклон EMA(50) на M15 практически горизонтален. Главная защита от "ловли ножей".
Свечной Паттерн (+25 очков): Сильный разворотный паттерн на M5 (Поглощение, Пин-бар и т.д.).
Микро-Структура / Уровень (+20 очков): Отбой от локального High/Low или пробой микро-контр-трендовой линии на M5.
Подтверждение Осциллятором (+15 очков): Stochastic на M15 в экстремальной зоне.
Подтверждение Choppiness Index (+15 очков): CHOP на H1 > 60.
Стратегия Night Breakout (Тип: "Королевский Сетап"):
Логика: Пробой азиатского "коридора" на M15 с подтверждением по всплеску тикового объема или Force Index.
Обоснование: Страховка от затяжного флэта, позволяет "запрыгнуть" в ночное движение.
Стратегия "Три Экрана для Флэта" (Тип: "Королевский Сетап"):
Логика: H1 (ADX < 20) -> M15 (Цена у Боллинджера + Stochastic в зоне) -> M5 (Дивергенция на MACD).
Обоснование: Самый надежный из флэтовых сигналов, дает сильное статистическое преимущество.
Блок 4: "Дневной Профиль" (Торговля в Тренде)
Задача: Создать флагманский, основной источник прибыли для торговли в трендовых и импульсных условиях.
Компонент: DualMA Anchor — наш основной генератор прибыли.
Полный Функционал:
Иерархия Скользящих: SMA 500 ("Гравитационный Центр"), EMA 200 (Основной тренд), EMA 100/50 (Тактические уровни), "Сигнальная Зона" (MA 1-10 с High/Low flip).
Типы Сигналов: "Пробой и Закрепление", "Отскок-Прокол" (False-Break, "Королевский Сетап"), "Предвход" (уменьшенным лотом от быстрых МА).
Фильтры Качества (Цепочка Подтверждений):
"Три Экрана Элдера (Трендовая Версия)": D1/H4 (Глобальный Тренд) -> H1/M15 (Тактический Сетап) -> M5/M1 (Триггер).
MA Stack (Стэк Скользящих): Огромный бонус к score, если все МА выстроены в правильном, трендовом порядке.
ADX & Force Index: Обязательные подтверждения силы тренда для всех входов.
Компонент: Усилители (ТА Контекст) — наши "глаза и уши".
Полный Функционал:
Triangle.HYBRID: Работает как индикатор рыночной фазы. Внутри треугольника Resolver отдает приоритет флэтовым сигналам, а на пробое — трендовым.
Fibo Extended: Автоматически ищет "Кластеры" (совпадения уровней Фибо). В MVP входы по Фибо отключены, но модуль активно поставляет информацию о барьерах (MinSpace) и целях (ТП).
Блок 5: "Мозг и Управление"
Задача: Создать центральный узел принятия решений и систему управления позициями, которые работают в синергии.
Компонент: "Мозг" / Дирижер (Resolver) — "центральный процессор" нашей системы.
Полный Функционал:
Трехуровневая Система Сигналов: Категория А ("Королевские Сетапы"), Категория Б ("Сигналы Конфлюэнса", score > 80), Категория С ("Сигналы-Усилители").
"Матрица Конфликтов и Конфлюэнса": Resolver использует матрицу для оценки взаимодействия сигналов (например, [DualMA LONG] + [Скрытая Дивергенция LONG] = score * 1.2).
"Флагманский" Сценарий Управления Объемом: На основе score (> 95 - полный объем, 80-95 - двумя частями) выбирает, как исполнить сигнал.
Компонент: Управление Позицией (Position Manager) — наш "финансовый директор".
Полный Функционал:
Tiered BE (Ступенчатый Безубыток): Тип и триггеры БУ напрямую зависят от категории сигнала (Королевский/Конфлюэнса), который его открыл.
"Освобождение Риска": После перевода сделки в БУ, ее риск немедленно освобождается, позволяя открывать новые сделки или доливки.
"Адаптивная Сетка ТП": TP1 (50% объема -> BE), TP2 (30%), TP3 ("Раннер").
Доливки (Add-ons): Разрешены только в режиме TREND на откатах к тактическим МА и только после "Освобождения Риска".
Часть 3: План Разработки (Спринты)
Спринт	Название	Ключевые Задачи	Результат
Спринт 1	Фундамент, Режим и Позиции	T2-CORE-REGIME (Движок Режимов), T2-RISK & T2-005 (Фундамент Безопасности), T2-PM (Управление Позицией)	Советник обладает "самосознанием", непробиваемой защитой и умным механизмом управления позициями.
Спринт 2	Ночной Двигатель и Контекст	T2-STRAT-NIGHT (Ночные стратегии), T2-002 (Triangle), T2-003 (Fibo)	Советник начинает безопасно и прибыльно торговать в периоды флэта.
Спринт 3	Дневной Двигатель и Мозг	T2-001 (DualMA Anchor), T2-007 (финализация Resolver-а)	Советник становится универсальным, способным торговать в любой фазе рынка.
