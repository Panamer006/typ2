Отработал трендовую к в учебнике
Кстати мы ведь можем выставлять лимитки от них автоматом, чтоб она была скользящей по ходу движения? Это будет как основная а при закрытие над/под будет идти доп сделка, так как твх может быть уже по худшей цене
ChatGPT сказал:
Думал на протяжении 1m 16s

Да, можно. Сделаем «скользящую» лимитку от трендовой + логику пробоя/ретеста. Коротко, как это работает в ЕА и какие дефолты поставить.

Автолимитка от трендовой

Как строим линию: ZigZag/Fractals → берём 2–3 последних подтверждённых свинга и считаем цену линии на текущем баре.
Где ставим лимитку:

Лонг: Buy Limit на цене нижней трендовой + Offset.

Шорт: Sell Limit на цене верхней трендовой – Offset.
Скользим: на каждом новом баре пересчитываем и переставляем ордер, но только если сдвиг ≥ MinRepricePts (чтоб не спамить брокера) и учитывая StopsLevel/FreezeLevel.

Рекоменд. параметры

UseTL_Limit = true

TL_Limit_Offset_ATR = 0.15–0.30 (буфер к линии, от ATR(14))

TL_Limit_MinRepricePts = 10–20

TL_Limit_TTL_Bars = 5 (время жизни, если не исполнился — отмена)

TL_MinTouches = 2 (минимум касаний для валидной линии)

Пробой / ретест / доливка

Пробой: закрылись за линией на BreakBuffer = 0.3×ATR → основную лимитку отменяем.
Опции:

ReverseOnBreak = true → переворот по рынку/стоп-ордером.

QueueRetest = true → ставим лимитку на ретест у той же линии (ставшей поддержкой/сопротивлением) с RetestWindowBars = 3.

Доливка на ретесте: AddOnRetest = true, AddLotFrac = 0.3–0.5, минимум расстояния от предыдущего входа Add_MinDistancePts = 300–500.

Стоп/трейл (структурно)

SL = линия ∓ kATR (лонг: ниже линии; шорт: выше), kATR = 0.6–0.8.

StructureTrail = on: тянуть стоп под/над последним HL/LH или вдоль трендовой ± 0.3×ATR.

Защиты и «гигиена»

Спред ≤ медианы + 1σ за 100 баров; иначе не переставляем и не ставим лимитку.

ADX ≥ 20 (или SuperTrend в нашу сторону) — допуск к постановке.

Сессии/новости: не ставим/не двигаем внутри локера (30–60 мин до/после high-impact).

Сетевые/биржевые ограничения: проверяем StopsLevel/FreezeLevel, перестановки не чаще 1 раз в бар (или OnTimer раз в N секунд).

Неттинг/хедж

Netting: лимитка может увеличить текущую позицию — контролируем суммарный риск и закрытия частями.

Hedging: используем уникальный Magic и comment, билеты храним для модификаций/отмен.

Что это даст

В тренде вход ближе к «идеалу» (от линии), но без «догонялок».

Если ушли без нас — не прыгаем по худшей цене, ждём ретест или работаем по пробою (переворот/доливка).

Существенно меньше ложных ТВХ за счёт ATR-буферов, ADX/сессий, и ограничений на перестановки.

Если хочешь — добавлю это в нашего ЕА как блок с такими input (всё оптимизируемо в MT5):

UseTL_Limit, TL_Limit_Offset_ATR, TL_Limit_MinRepricePts, TL_Limit_TTL_Bars, BreakBuffer_ATR, QueueRetest, RetestWindowBars, AddOnRetest, AddLotFrac, SL_kATR, StructureTrail
и включу дефолты: Offset=0.2ATR, Break=0.3ATR, Retest=3 бара, AddLot=0.4, SL=0.7ATR.

Вы сказали:
А от самой скользящей в каком случае есть смысл ставить лимитку? Там же можно играться с параметрами бай стоп или сел
ChatGPT сказал:
Думал на протяжении 44s

Коротко: лимитка от МА имеет смысл как «вход-откат в тренде» или «контрдвиж в боковике». Если ожидаешь пробой/импульс, лучше стоп-ордер. Ниже — когда и как.

Когда ставить лимитку от МА
1) Откат в тренде (лучший кейс)

Условие: цена выше медленной МА (напр. EMA50/EMA90/EMA200), её уклон положительный, ADX ≥ 20.

Действие: Buy Limit на цене МА – offset, где offset = 0.15–0.30 × ATR(14).
Шорт зеркально: ниже МА с отрицат. уклоном — Sell Limit МА + offset.

Стоп: за МА ± 0.6–0.8 × ATR; трейл — под/над последним HL/LH.

Классная «конфлюэнс»-зона: пересечение МА + трендовая → лимитка именно туда.

2) Возврат к среднему во флэте

Условие: ADX < 18, CHOP высокий (пила), МА почти ровная.

Действие: можно ставить двусторонние лимитки (fade):
Buy Limit немного ниже МА и Sell Limit выше МА, цели — возврат к МА/середину канала.
(На новостях/широком спреде — НЕ применять!)

Когда лучше стоп-ордер от МА
3) Перехват импульса / «перевзятие» МА

Условие: был откат/консолидация под МА, появилось закрытие над МА (лонг) с объёмом/длиной свечи.

Действие: Buy Stop МА + 0.2–0.4 × ATR после 1–2 баров закрепления.
Шорт зеркально.

Это защищает от ситуации, когда лимитку «перескочили» и уехали.

Как это зашить в советник (всё оптимизируемо)

Параметры:

UseMA_Limit=true, MA_Period=20|50|90, MA_Method=EMA, MA_Price=Close

MA_Limit_Offset_ATR=0.2, MA_Limit_TTL_Bars=5, MA_Limit_MinRepricePts=15

UseMA_Stop=true, MA_Stop_Buffer_ATR=0.3, MA_ReclaimBars=1

Фильтры: ADX_Min=20, MA_MinSlopePts=5, UseCHOP_Flat=true

Риски: SL_kATR=0.7, StructureTrail=true, DailyLossLimit_R=2

Логика:

Если Trend (уклон МА>0 и ADX≥20) → включаем MA-Limit в сторону тренда, отменяем при пробое МА на 0.3×ATR и ждём ретест.

Если импульсное перевзятие МА → ставим MA-Stop.

Если Flat (CHOP высокий, ADX низкий) → разрешить двусторонние лимитки в узком канале (опционально).

Всегда проверяем спред: spread ≤ median + 1σ последних 100 баров; новости — локер (±30–60 мин).

Дефолты (с которых начать):

Тренд-вход по EMA50 лимиткой 0.2 ATR, стоп 0.7 ATR;

Импульс — стоп-ордер 0.3 ATR после 1 бара закрепа;

Фильтры: ADX≥22, уклон EMA50>0 (лонг) / <0 (шорт).

Если хочешь, включу в нашего ЕА оба режима (UseMA_Limit и UseMA_Stop) с этими дефолтами + «конфлюэнс» с трендовой (ставим лимитку только если расстояние от МА до трендовой ≤ 0.25 ATR). Это даст аккуратные входы «от уровня», а когда рынок уходит без отката — берём его стоп-ордером.

Вы сказали:
То есть мы сможем это тоже отшлифовать на истории и принять решение где работает а что лучше убрать вовсе?
ChatGPT сказал:
Думал на протяжении 30s

Да, именно так. Все «новые фичи» можно отшлифовать на истории и решить, что оставить/включать по режимам, а что убрать.

Вот как это делаем, чтобы не перегнуть с переоптимизацией.

План тестов (коротко и по делу)

Флаги-переключатели
У каждой фичи есть input bool, значит её легко включать/выключать в оптимизаторе:

UseMA_Limit, UseMA_Stop

UseTrendlines, UseTL_Limit, ReverseOnBreak, AddOnRetest

UseTriangle

StructureTrail

UseHTFRegime (EMA200 H4 + уклон)

UseADX, UseSqueeze, UseDonchian, UseATRPercentile, SpreadStatFilter, NewsFilter
…и т. п.

Бенчмарк → абляция → сборка

Базовая система (твоя MA/DEMA + 3 TP) = бенчмарк.

Абляционные тесты: добавляем ровно одну фичу к бенчмарку → смотрим OOS (out-of-sample). Дальше – попарные сочетания, но только тех фич, что показали прирост.

В итоге собираем «пакеты» под TREND / NORMAL / FLAT.

Форвард-оптимизация и роллинг

История делится на: train (настройка) → forward (проверка).

Роллинг-окна (например, 6 мес train → 1 мес forward, прокатить 6–12 раз) — видно стабильность.

Критерий качества (OnTester)
Используем композит (в коде легко посчитать):

Score = Expectancy_per_trade * Trades * sqrt(PF)
        − 0.5 * MaxDD% − 0.01 * StagnationDays
        − 0.1 * Complexity


Где Complexity = число включённых фич. Плюс ограничения:

Trades ≥ 150, PF ≥ 1.2, MaxDD ≤ 20%, WinRate ≥ 42% (на train);

На forward: PF ≥ 1.1 и NetProfit > 0.

Монте-Карло устойчивость
Для лучших наборов прогон с рандомизацией: порядок сделок, спред/проскальзывание. Берём только те, где 5-й перцентиль PnL ≥ 0.

Правило принятия решения
Фича «остаётся», если:

на нескольких forward-срезах даёт прирост Score ≥ +5–10% к бенчмарку,

и в Монте-Карло не проваливается (5-й перцентиль ≥ 0).
Если прирост только в одном режиме — включаем её только там (через авто-режимник).

Что именно проверяем (конкретика)

MA-лимитка vs MA-стоп

Рanges: Offset_ATR 0.15..0.35, StopBuffer_ATR 0.2..0.4, ReclaimBars 1..2.

Ожидание: лимитка лучше в TREND с ADX≥20; стоп лучше при «перевзятии» МА после консолидации.

Трендовые/ретест/переворот

BreakBuffer_ATR 0.2..0.6, RetestBars 1..5, SL_kATR 0.6..0.8.

Ожидание: прирост в тренде на H1/H4, во флэте — отключать или оставлять только «выход по пробою» (без переворота).

Треугольник

Convergence 40..70%, BreakBuffer_ATR 0.2..0.5.

Ожидание: редко, но жирно — оставить как сигнал повышения размера TP2/TP3, а не как частый вход.

Фильтры

ADX_Min 18..28, ATR_Percentile_Min 30..60, Squeeze 5..20 перцентиль, Donchian 10..55.

Ожидание: меньше ложных ТВХ, особенно на EURUSD.

Гигиена

Spread ≤ median+1σ, News lock 30–60 мин, DailyLossLimit_R 1.5..3, CoolDownAfterLosses 1..3.

Ожидание: просадка и «зубья» эквити заметно сглаживаются.

Что смотреть в отчётах (кроме P/L)

Hit-rate TP1/TP2/TP3 до SL (в %).

MAE/MFE-профиль (средн. неблагоприятное/благоприятное движение) — видно, где трейл и BE поставить.

By-session / by-weekday — у многих систем часть прибыли делается Лондон+NY.

Regime-split (TREND/NORMAL/FLAT): где каждая фича реально даёт профит.

Итог

Да, всё это реально отобрать и довести: включаем фичи флагами, гоняем абляцию + форвард, проверяем Монте-Карло и оставляем то, что стабильно даёт прирост, причём по режимам.

Если готов, я сформирую три стартовых пакета параметров (TREND / NORMAL / FLAT) для EURUSD H1 и USDJPY H1 и матрицу оптимизации (что и в каких диапазонах крутить).

Вы сказали:
Мой комп не потянет оптимизацию стольких параметров, есть бесплатные серваки для таких тестов?
ChatGPT сказал:
Думал на протяжении 1m 10s

Коротко: «бесплатных мощных серверов» под MT5-оптимизацию почти нет. Но есть рабочие варианты:

Реально бесплатные/почти бесплатные

Фарм из своих/дружеских ПК (LAN-агенты MetaTester)
На каждом ПК ставишь MetaTester 5 Agents Manager, задаёшь пароль и кол-во агентов (≈ кол-во потоков–1), открываешь порты и добавляешь их в тестере как Remote agents. Это бесплатно и масштабируется сколько найдёшь машин.

Триалы облаков (хватает на 1–2 недели активных прогонов)
Почти у всех есть приветственные кредиты: создаёшь Windows Server ВМ и гоняешь оптимизацию, пока не закончатся кредиты. Платить не придётся, если уложишься в лимит. (Перебирать только нужные параметры, генетика/форвард — чтобы не сжечь лимит зря.)

Дёшево и удобно (но не free)

MQL5 Cloud Network
Встроенная «облачная ферма» в тестере. Это не бесплатно, но очень гибко: платишь за минуты процессора, а скорость — как у большой фермы. Для разовых больших оптимизаций часто выходит дешевле и проще, чем держать свой сервер.

Спот-инстансы в облаках
Если триала мало — можно взять Windows-ВМ на spot/preemptible-тарифах (существенно дешевле обычных). На ночь запускаешь прогон, утром — результаты.

Как уменьшить потребность в железе

Делай ступенчатую оптимизацию (входы → выходы → доливки → структура), а не всё сразу.

Включай Genetic и Forward-optimization; режь поиск по диапазонам с «плато», а не по всему полю.

Оптимизируй масштабы (например, TP/SL в долях ATR/базовых пресетов), а не «голые пункты».

Флаги новых фич (MA-лимитка/стоп, трендовые, треугольник, фильтры) крути как on/off — быстро видно, что действительно даёт прирост.

Если хочешь, дам короткий чек-лист по настройке LAN-фермы агентов и минимальные диапазоны параметров под EURUSD/JPY H1, чтобы прогон занял часы, а не дни.

Вы сказали:
Какой лучше для этого использовать сервер?
И можем ли мы с тобой по старой дружбе сделать набор команд для оптимизации, которые бы автоматом шли и шли необходимые количество раз
ChatGPT сказал:
Думал на протяжении 1m 35s

Босс, по делу.

Какой сервер брать под MT5-оптимизации

Главное — CPU. Нужны много ядер + высокая частота. Память и диск вторичны.

Конфиг “сладкая точка”

Windows Server 2022 (из коробки дружит с MT5/агентами).

32–64 vCPU, 64–128 ГБ RAM, NVMe SSD.

Проц: современные Intel (Ice/ Sapphire Lake) или AMD EPYC 7xx3/9xx4 с AVX2.

План питания “High performance”, агентов = числу логических ядер − 1.

Из облаков (лучшее соотношение цена/скорость)

AWS: c6a.8xlarge / c6a.12xlarge (AMD) или c7i.8xlarge (Intel).

GCP: C2 (c2-standard-30/60) или C3.

Azure: Fsv2 (F32s_v2/F64s_v2).
Если хочется сильно сэкономить — Spot/Preemptible (и перезапускать при отъёме ресурса) или вообще не мучиться и включать MQL5 Cloud Network прямо в тестере (самый простой «серверless»-вариант, но платный поминутно).

«Набор команд», чтобы гонки шли сами

MT5 умеет стартовать оптимизации из консоли. Схема такая:

компилируем ЕА;

запускаем терминал с ini-конфигом тестера;

повторяем по символам/ТФ/окнам.

1) Компиляция из консоли
REM 1_compile.bat
set METAEDITOR="C:\Program Files\MetaTrader 5\metaeditor64.exe"
%METAEDITOR% /compile:"MQL5\Experts\EA_MA_3TP_ATR_TRAIL.mq5" /log:"logs\compile.log"

2) Пример ini для оптимизации (configs\EURUSD_H1.ini)
[Common]
Profile=Tester

[Tester]
Expert=EA_MA_3TP_ATR_TRAIL.ex5
ExpertParameters=presets\EURUSD_H1_base.set
Symbol=EURUSD
Period=H1
Model=2                 ; Every tick based on real ticks (по желанию)
FromDate=2023.01.01
ToDate=2024.08.31
ForwardMode=1          ; 1-Fixed, 2-By parts
ForwardDate=2024.04.01 ; если Fixed
Deposit=10000
Leverage=100
Optimization=1         ; 0-нет, 1-полная/генетика
Genetic=1              ; генетика включена
Criterion=6            ; 6=Custom max (через OnTester), иначе 0=Profit и т.д.
UseLocal=1
UseRemote=1            ; задействовать удалённые агенты (LAN/облако)
UseCloud=0             ; или 1, если берёшь MQL5 Cloud
Report=reports\EURUSD_H1.html


В разных билдах ключи могут называться Report/TestReport, Criterion/OptimizationCriterion — это видно в журнале терминала; если что, переименуем.

3) Батник, который крутит символы/ТФ/роллинг-окна
REM 2_run_optimizer.bat
set TERMINAL="C:\Program Files\MetaTrader 5\terminal64.exe"
set CFG=.\configs
set LOG=.\logs

for %%S in (EURUSD USDJPY) do (
  for %%TF in (H1) do (
    for %%R in (TREND NORMAL FLAT) do (
      copy /Y presets\%%S_%%TF_%%R.set presets\work.set >nul
      copy /Y %CFG%\template.ini %CFG%\run_%%S_%%TF_%%R.ini >nul
      REM правим пару строк (можно через утилиту sed или PowerShell):
      powershell -Command ^
        "(Get-Content %CFG%\run_%%S_%%TF_%%R.ini) ^
          -replace 'Symbol=.*','Symbol=%%S' ^
          -replace 'Period=.*','Period=%%TF' ^
          -replace 'ExpertParameters=.*','ExpertParameters=presets\\work.set' |
         Set-Content %CFG%\run_%%S_%%TF_%%R.ini"
      start /wait %TERMINAL% /portable /config:%CFG%\run_%%S_%%TF_%%R.ini /log:%LOG%\%%S_%%TF_%%R.log
    )
  )
)

4) Вариант «роллинг-форвард» (PowerShell)
# 3_walkforward.ps1
$terminal = "C:\Program Files\MetaTrader 5\terminal64.exe"
$cfgTmpl  = ".\configs\template.ini"

function Run-Window($sym,$tf,$from,$to,$fwdFrom){
  $cfg = ".\configs\run_${sym}_${tf}_${from}_${to}.ini"
  (Get-Content $cfgTmpl) `
    -replace 'Symbol=.*', "Symbol=$sym" `
    -replace 'Period=.*', "Period=$tf" `
    -replace 'FromDate=.*', "FromDate=$from" `
    -replace 'ToDate=.*', "ToDate=$to" `
    -replace 'ForwardDate=.*', "ForwardDate=$fwdFrom" |
    Set-Content $cfg
  & $terminal /portable /config:$cfg /log ".\logs\${sym}_${tf}_${from}_${to}.log"
}

$sym="EURUSD"; $tf="H1"
$windows = @(
  @{f="2022.01.01"; t="2023.01.01"; fwd="2022.10.01"},
  @{f="2023.01.01"; t="2024.01.01"; fwd="2023.10.01"},
  @{f="2024.01.01"; t="2024.09.01"; fwd="2024.06.01"}
)
$windows | ForEach-Object { Run-Window $sym $tf $_.f $_.t $_.fwd }

5) Где хранить результаты

Report=…html — общая сводка оптимизации.

В ЕА реализуем OnTester()/OnTesterPass() → пишем CSV с Score, PF, DD, WinRate, Trades, Inputs — удобно потом отфильтровать топ-наборы.

Бонус: как ускорить и не «упереть» железо

Делить задачу на пакеты (входы → выходы → доливки → структура).

Крутить флаги новых блоков как on/off — быстро понятно, что реально полезно.

Оптимизировать масштабы (в долях ATR/базовых пресетов) вместо «голых пунктов».

Включить Genetic + Forward; ограничить диапазоны до разумных.

Поднять LAN-агентов на всех доступных ПК (бесплатно и сильно ускоряет).

Если хочешь, я подготовлю тебе шаблон template.ini, набор .set-пресетов TREND/NORMAL/FLAT и минимальные PowerShell/Batch-скрипты под твой путь установки — вставишь логин/сервер, запустишь «комбайн», и оптимизации поедут одна за другой без ручного клика.

Вы сказали:
В Яндекс сервак даёт месяц бесплатно тестовый, нам же хватит обкатать настройки по идее?
ChatGPT сказал:
Думал на протяжении 1m 32s

Короткий ответ: да, тестового месяца Яндекс.Облака обычно хватает, чтобы «обкатать» пресеты и отсеять лишние фичи — при разумных диапазонах и генетике. Чтобы уложиться в лимит, держим 1–2 мощные ВМ и режем задачу на пакеты.

Почему ок

У Яндекс.Облака есть пробный период с первоначальным грантом — во время триала расходы списываются из этого гранта. 
Yandex Cloud

Можно брать preemptible ВМ (прерываемые) — они сильно дешевле, но их раз в ~24 часа могут останавливать. Для оптимизаций это норм: запускаем короткими окнами или скриптом перезапускаем следующий пакет. 
Yandex Cloud
+1

Если гранта не хватит — всегда можно докинуть мощности через MQL5 Cloud Network (поминутно, платно) или подключить LAN/remote-агентов. 
metatrader5.com

Что брать из конфигураций (практично)

Windows Server 2022 на ВМ с 32 vCPU / 64–128 ГБ RAM / NVMe (или две по 16 vCPU как «ферму» remote-агентов). Важнее всего частота CPU.

В настройках агентов: по числу логических ядер минус 1; план питания — «High performance».

Если жаль кредит — возьми preemptible инстанс и запускай оптимизации пакетами до 12–18 часов каждая (чтобы не попасть под авто-остановку). 
Yandex Cloud

Как уложить оптимизации в 1 месяц (план-минимум)

Ступень 1 (день 1–3): входы/фильтры (HTF, ADX/CHOP/ATR-perc, Donchian) — генетика, узкие диапазоны.

Ступень 2 (день 4–7): выходы (TP-скейлы, BE/трейл), on/off трендовые/ретест/переворот.

Ступень 3 (неделя 2): доливки и MA-лимитка/стоп.

Ступень 4 (недели 3–4): walk-forward + Монте-Карло на топ-наборах, только подтверждение устойчивости.

Автозапуск «комбайна»

Мы уже наметили батники/PS-скрипты выше. Их хватит, чтобы без кликов гнать пачки по символам/ТФ/окнам (через /config у terminal64). Добавь в ini: UseRemote=1 (подключишь вторую ВМ) и, при желании, UseCloud=1 — тогда в ход пойдёт MQL5 Cloud. 
metatrader5.com
+1

Если хочешь, я сейчас подгоню тебе минимальный комплект конфигов под Яндекс.ВМ (Windows), с пресетами TREND/NORMAL/FLAT и короткими окнами, чтобы спокойно вписаться в месяц.