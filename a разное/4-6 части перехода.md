Часть 4 — Жизненный цикл сделки: Order Engine, Position Manager, риск и лицензия
Order Engine

Типы заявок:

LIMIT для Bounce/EDGE/RETEST,

STOP (опция) для BREAKOUT.

TTL: каждая отложка имеет срок жизни в барах (TTL_Bars), по истечении — EXPIRED.

Репрайс:

для DMA-сценариев цена лимитки подстраивается к «актуальному» уровню (MinRepricePts — минимальное смещение).

Очередь ретестов:

после BREAK планируется Retest-задача (буфер в ATR, TTL).

ReverseOnBreak:

если цена уходит «по другую сторону» рабочей средней (DMA), заявка переводится в REVERSED (дальше — по политике).

Риск-лот:

если OE_DefaultLots>0 — фикс,

иначе: риск от Equity/Balance × %, делим на (SL в пунктах × стоимость пункта), с запасным ATR fallback если SL не посчитан.

учёт SYMBOL_VOLUME_STEP/MIN/MAX, округление.

Position Manager

TP1/TP2/TP3: расстояния в R (R = |entry-SL| в пунктах), на каждом таргете — частичное закрытие долей.

После TP1 (опция): перевод SL в BE ± offset.

После TP2 (опция): включение ATR-трейлинга (SL подтягивается на ATR*mult).

Логи по событиям PM — в typ2_pm_log.csv.

Лицензирование и режимы (для Market)

FULL — без ограничений (можно ограничить реальными аккаунтами через License_AllowAccounts).

DEMO — реальная торговля блокируется (включается DryRun), watermark через Comment().

TRIAL — допускается реальная торговля, но действуют License_ExpiryDate, License_MaxLotsDemo, License_MaxPending.

При блокировке — логика остаётся «виртуальной» (для демонстрации в тестере), торговые операции не отправляются.

Часть 5 — Настройки, быстрый старт, оптимизация, тестирование и публикация
Ключевые входные параметры (смысл)

General / License

Magic, DryRun, TradeTF, MaxSpreadPts, License_Mode, License_AllowAccounts, License_ExpiryDate, лимиты.

Фильтры

UseTradingHours, TradeHours, FridayCutoff;

UseSpreadStat, SpreadLookback, SpreadSigmaK;

UseATRPercentile, ATR_Perc_Lookback, ATR_Perc_Min;

UseCHOP(+параметры), UseADX(+параметры);

NewsCSV_Enabled, News_*.

Triple Screen

TS_ModeSetting (HARD|SOFT), TF_Trend/H1/H4, веса TS_W_*, TS_ScoreThreshold;

включение/отключение Setup_UseDMA, Setup_UseTriangle;

UseForceTrigger, UseEnvelopesTrigger, Trigger_ANY.

CCY Bias

Bias_TF, Bias_Lookback, Bias_SmoothEMA, Bias_UseZScore, Bias_Threshold, Bias_HardBlockInHARD.

Signals

DualMA: DMA_* (периоды, ATR-буферы, UseBreakStop, SL-множители).

Triangle: TRI_* (фракталы, окна, ATR-буферы, SL, STOP/RETEST).

Fibo: AB_LookbackBars, AB_MinLenATR (зарезервировано).

Resolver

W_*, OnePerReasonBar, ReasonCooldownBars.

Order Engine

TTL_Bars, MinRepricePts, QueueRetest, ReverseOnBreak,

риск-блок: OE_DefaultLots, OE_Risk_Percent, OE_Risk_FromPlannedSL, OE_Risk_ATRmultFallback, OE_UseEquityInsteadOfBalance.

Position Manager

PM_PartialTPs, PM_TP{1,2,3}_R, PM_TP{1,2,3}_ClosePct, PM_MoveBE_AfterTP1, PM_BE_OffsetPts, PM_ATRTrail_AfterTP2, PM_ATR_Period, PM_ATR_Mult.

Быстрый старт

Скопировать файлы архива в MQL5/Experts/<Проект>/, скомпилировать TakeYourProfitEA2.mq5.

(Опц.) news.csv в MQL5/Files/, включить NewsCSV_Enabled=true.

Тестер: EURUSD M15, загрузить SET_EURUSD_M15.set.

Для реала — License_Mode=LM_FULL (при необходимости allow-list).

Оптимизация (локально/remote/cloud агенты MT5)

Разбить параметры на «крупные ручки»: Triple Screen (режим, веса), ATR-буферы сетапов, OE-параметры TTL/репрайс, PM-цели/доли.

Запускать walk-forward: in-sample подбор → out-of-sample проверка; сохранять лучшие пресеты.

Для трендовых инструментов начать с TS_Mode=HARD, затем сравнить с SOFT (выбор «качество против частоты»).

Логи typ2_log.csv и typ2_pm_log.csv использовать для диагностики шаблонов входов/выходов.

Тестирование и контроль качества

Граничные случаи:

сверхузкий/резкий рост спреда → фильтр должен блокировать,

отсутствие новостей или пустой CSV → фильтр не должен падать,

низкий ATR-процентиль/высокий CHOP → блок,

событие BREAK без ретеста в TTL — корректно истекает,

позиция достигает TP1 → частичное закрытие + BE,

TP2 → включился ATR-трейл, SL подтягивается.

Регрессии: повторные прогоны с фикс-параметрами, сравнение CSV-логов.

Визуальный режим: проверка точек входа/выхода и типов заявок.

Публикация в MQL5 Market

Демо-ограничения через License_Mode (DEMO/TRIAL), watermark.

Приложить README (RU/EN), скриншоты визуального тестера, отчёты оптимизации (графики качества).

Описание: модули, фильтры, система лицензии, рекомендации по оптимизации, примеры пресетов.

Часть 6 — Статус «сделано/в работе/план» и следующие шаги
Готово (MVP собран и работает)

Архитектура и корневой пакет (20 файлов).

Сигналы: DualMA / Triangle / Fibo (+ SL/ATR).

Triple Screen (HARD/ SOFT), Force/Envelopes как триггеры.

CCY Bias (EMA + z-score, delta, доминанта, headwind).

Фильтры: спред (жёсткий/стат), часы, ATR-процентиль, Choppiness, ADX, CSV-новости, режим рынка.

Resolver (веса/штрафы, анти-спам).

Order Engine (TTL/репрайс/ретест/реверс, риск-лот).

Position Manager (TP1/2/3, BE, ATR-трейл).

Лицензирование (FULL/DEMO/TRIAL).

README/CHANGELOG, пресет EURUSD M15, пример news.csv.

В работе / запланировано (по материалам прошлого чата)

Triple Screen — расширенные триггеры: RSI/Stochastic (переключаемые), тонкая калибровка TS_W_*, подбор TS_ScoreThreshold.

Кросс-фильтр доминанты через корреляцию пар (пример: EURGBP решает приоритет EUR vs GBP; влияние на EURUSD/GBPUSD; для JPY — кроссы и USDJPY).

Родительский риск-контур (не просто заглушка): дневной лимит потерь/числа сделок, «охладитель» после серии стопов.

Портфельный риск и мульти-символьный проходчик: разнесение по символам, общий лимит риска/корреляции, очередность сканирования.

Новости: альтернативный источник (системный календарь), правила «High-only», «By country», «режим перекрытий».

Пакет пресетов: для EURUSD, GBPUSD, USDJPY, XAUUSD, US30/GER40 (CFD, если брокер разрешает), с описанием профиля.

WFO/репортинг: гайд/скрипт на базе Tester → сводные таблицы/графики (в README).

Документация к релизу: доп. скриншоты (визуал), FAQ, таблица параметров, советы по брокерам (спред/ликвид) — без рекламы.

Следующие шаги (итеративно)

Доработать Triple Screen триггеры (RSI/Stoch, опции ANY/ALL, дефолтные уровни) и калибровать веса SOFT.

Реализовать «EURGBP-решающий» фильтр в CCY Bias/Resolver (удобно как флаг + поправка score).

Дневной риск-менеджер: лимиты и «охладитель» по количеству стопов.

Собрать пресеты на 3–5 символов и прогнать первичную оптимизацию (EURUSD/GBPUSD/USDJPY, M15).

Обновить README (секция оптимизации и примеры результатов), подготовить скриншоты для MQL5 Market.

Приложение — Ссылка на текущий архив

Архив корневого релиза (20 файлов):
TYP2_Release_v2.0.0.zip

хочешь — можем сразу перейти к п.1 из «Следующих шагов» (расширенные триггеры Triple Screen), либо к п.3 (дневной риск-контур), если приоритет — безопасный прогон в реал-условиях.