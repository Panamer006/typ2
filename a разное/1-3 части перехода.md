Часть 1 — Подготовка к переходу в новый чат (handover) и краткий executive summary

Ниже — полный «пакет передачи» проекта Take Your Profit EA 2.0: структура, логика, что готово и что дальше. Этого текста достаточно, чтобы любой новый чат мгновенно подхватил работу без потерь.

Что вставить ПЕРВЫМ сообщением в новый чат (handover seed)

Скопируй и вставь целиком этот блок в новый чат проекта:

[Handover Seed — Take Your Profit EA 2.0]
Контекст: перенос проекта много-модульного советника MT5 (MQL5) с готовым корневым релизом на 20 файлов. Нужна полная продолжательная работа по доработке логики и релизной подготовке под MQL5 Market.

Архив (корень ≤20 файлов): TYP2_Release_v2.0.0.zip
Состав архива:
- TakeYourProfitEA2.mq5 — главный файл эксперта (OnTick orchestration, сигналы, фильтры, Triple Screen, Resolver, Order Engine, Position Manager, лицензия).
- typ_core.mqh — общие типы/структуры.
- typ_news_csv.mqh — CSV-новости, оконное блокирование.
- typ_filters.mqh — фильтры: спред (жёсткий/статистический), часы, ATR-процентиль, Choppiness, ADX, режим рынка, «родительский» фильтр-заглушка.
- typ_ccybias.mqh — корзинный индекс силы валют (EUR/USD/GBP/JPY/AUD/CAD/CHF/NZD), EMA-сглаживание, z-score, дельта доминанты.
- typ_force.mqh — Force Index (EMA) как триггер.
- typ_envelopes.mqh — касание конвертов как триггер.
- typ_triplescreen.mqh — Элдер: тренд(H4)/сетап(H1)/триггер(M15), HARD/ SOFT.
- typ_dualma.mqh — MA200/MA34: Bounce/Break/Retest с ATR-буферами, опция STOP или RETEST.
- typ_triangle.mqh — симм. треугольники: EDGE_FADE, BREAKOUT, RETEST.
- typ_fibo.mqh — зона 50–61.8% (SL у 78.6%).
- typ_resolver.mqh — взвешивание кандидатов по весам + штраф headwind от CCY Bias.
- typ_order_engine.mqh — отложки (TTL, авто-репрайс DMA, очередь ретестов после BREAK, reverse-on-break), риск-лот от SL/ATR, equity/balance.
- position_manager.mqh — частичные TP (R1/R2/R3), перевод в BE, ATR-трейл.
- license_guard.mqh — FULL/DEMO/TRIAL, allow-list аккаунтов, expiry, лимиты, watermark.
- README_MQLMarket_{ru,en}.md — описание для маркетплейса.
- CHANGELOG.md — история.
- SET_EURUSD_M15.set — стартовый пресет.
- news.csv — пример календаря.

Статус:
- Базовая логика собрана и компилируема. Работают: сигналы (DualMA/Triangle/Fibo), Triple Screen (HARD/ SOFT), CCY Bias, фильтры, Resolver, Order Engine, Position Manager, лицензирование.
- Требуются доработки по плану: расширенные триггеры для Triple Screen (RSI/Stoch), кросс-фильтр «EURGBP-решающий» для доминанты USD/корзин, портфельный риск-менеджер, мульти-символьный проходчик, доп. пресеты и WFO-пайплайн, усиление новостей (вкл. системный календарь), финполировка README/скриншоты.

Задачи первого этапа (закрыть последовательно):
1) Довести Triple Screen: добавить триггеры RSI/Stochastic (переключаемые), калибровать веса SOFT-режима.
2) Внедрить кросс-фильтр межвалютной доминанты (пример: EURGBP как решающий для EUR vs GBP и headwind/assist для EURUSD/GBPUSD).
3) Завершить «родительский» risk-контур: дневной лимит потерь/числа сделок.
4) Добавить пресеты для мажоров (EURUSD, GBPUSD, USDJPY, XAUUSD и т.д.) и черновой WFO-скрипт (описание).
5) Финальная подготовка к Market: описание/скриншоты/гайды по оптимизации, демо-ограничения.

Просьба новому чату:
- Подтвердить структуру архива, предложить план-итерации по задачам выше.
- При запросе «собрать/компилировать» — ориентироваться на MT5, без сторонних DLL.
[End Handover Seed]

Executive summary (для нового чата и документации)

Take Your Profit EA 2.0 — модульный советник MT5, объединяющий три независимых сетапа входа (DualMA, Triangle, Fibo) под зонтичной системой Triple Screen (Элдер) и корзинным валютным уклоном (CCY Bias). Качество входов контролируется набором фильтров (спред, часы, ATR-процентиль, Choppiness, ADX, новости). Resolver выбирает лучший сигнал по весам и штрафам. Order Engine ставит отложенные заявки, ведёт репрайс и ретест, умеет «реверс на пробой». Position Manager управляет выходами: частичное закрытие по целям R1/R2/R3, перевод в BE и ATR-трейлинг. Доступны режимы лицензии (FULL / DEMO / TRIAL) с ограничениями и водяным знаком.

Пакет подготовлен для публикации в MQL5 Market: README (RU/EN), CHANGELOG, стартовый пресет, ограничение в 20 файлов соблюдено. Оптимизация рассчитана на локальные/удалённые/облачные агенты MT5.

Часть 2 — Полная структура проекта и архитектура модулей
Дерево и назначение файлов (20 файлов)

TakeYourProfitEA2.mq5 — главный файл: инициализация (лицензия, OrderEngine), синхронизация по бару, вызов модулей сигналов → фильтров → Triple Screen → Resolver → исполнение, логирование.

typ_core.mqh — общие типы: направление, виды отложек/состояний, структуры SignalCandidate, FilterState, PendingOrder, RetestTask, TripleScreenState, CCYBiasState.

typ_news_csv.mqh — календарь новостей из news.csv (разделитель ;), границы окон pre/post, фильтр по валютам символа, минимальная важность.

typ_filters.mqh — фильтрующий конвейер:

жёсткий спред (в пунктах) и статистический спред (скользящее окно, σ-фильтр),

торговые часы + «пятничный отсеч»,

ATR-процентиль, Choppiness Index, ADX,

режим рынка (TREND/FLAT) с гистерезисом,

«родительский» фильтр-заглушка (для дневных правил),

интеграция с typ_news_csv.mqh.

typ_ccybias.mqh — CCY Bias:

корзины для EUR/USD/GBP/JPY/AUD/CAD/CHF/NZD (по 6–7 пар),

вычисление средней процентной смены за lookback с учётом стороны валюты (base/quote),

EMA-сглаживание, z-score нормализация, delta = S_base - S_quote, порог доминанты,

флаг «dominant» и «headwind/assist» при конфликте.

typ_force.mqh — триггер Force Index (EMA): использование тикового объёма × приращение цены, опции «требуемый кросс нуля», «знак по тренду».

typ_envelopes.mqh — триггер касания конвертов: проверка близости к верхней/нижней ленте.

typ_triplescreen.mqh — реализация Элдера:

Trend (H4) через EMA200 + наклон,

Setup (H1): либо DMA34 (касание/пробой), либо Triangle (EDGE/BREAK/RETEST),

Trigger (M15): Force и/или Envelopes (логика ANY/ALL),

HARD — все пункты обязательны; SOFT — скоринг с весами и штрафом за headwind (CCY Bias).

typ_dualma.mqh — DualMA-сетап:

MA1 (200 EMA) — трендовый фильтр (вкл/выкл),

MA2 (34 EMA LOW/HIGH/CLOSE) — работающая средняя,

Bounce (касание) / Break (с опц. STOP) / Retest (по ATR-буферам),

SL от ATR-множителя.

typ_triangle.mqh — Треугольники:

поиск последних двух фракталов вверх/вниз на окне поиска,

линейная аппроксимация трендовых границ (верх/низ),

EDGE_FADE (игра от границы), BREAKOUT, RETEST,

SL от ATR-множителя.

typ_fibo.mqh — Fibo-зона:

автоматический поиск последней ветви A→B,

интерес зона 50–61.8% (entry=mid), SL у 78.6%.

typ_resolver.mqh — выбор лучшего сигнала:

базовые веса по типам (DMA Bounce/Retest/Break; TRI Edge/Retest/Break; Fibo),

добавка скоринга от Triple Screen (SOFT),

штраф «headwind» от CCY Bias,

анти-спам: OnePerReasonBar + cooldown.

typ_order_engine.mqh — исполнитель:

генерация отложек (LIMIT/STOP) под причину,

TTL по барам, авторепрайс (например, по DMA-уровню),

очередь ретеста после BREAK (отложка на откат),

ReverseOnBreak (разворот логики, если цена ушла против ожидания),

риск-лот: от баланса/эквити, от планового SL (либо ATR fallback).

position_manager.mqh — управление позицией:

TP1/TP2/TP3 как кратные R (расстоянию до SL),

частичные закрытия по долям, перевод в BE после TP1,

ATR-трейлинг после TP2,

логирование в typ2_pm_log.csv.

license_guard.mqh — лицензия:

FULL/DEMO/TRIAL, allow-list аккаунтов, дата истечения,

лимит лотов/числа отложек, watermark через Comment(),

при блокировке — торговля выключена (DryRun).

README_MQLMarket_ru.md / README_MQLMarket_en.md — описание для маркетплейса.

CHANGELOG.md — история изменений.

SET_EURUSD_M15.set — стартовый пресет (H4/H1/M15, HARD).

news.csv — пример CSV-календаря.

Точки входа и потоки

OnInit() → лицензия, первичная инициализация Order Engine.

OnTick() → вызов OE_OnTick()/PM_OnTick() для событий уровней, затем на новом баре TradeTF:

опрос сигналов: DualMA_Probe, Triangle_Probe, Fibo_Probe;

фильтры качества AllFiltersAllow();

Triple Screen: HARD — строгое допуск/блок, SOFT — скоринг;

Resolver: выбор «лучшего» сигнала по весам/штрафам;

Order Engine: постановка отложки + (опц.) план ретеста.

OnTradeTransaction() → хук для PM (фиксация новой позиции и подготовка целей/BE).

Часть 3 — Детальная логика торговли (сигналы, фильтры, Triple Screen, Resolver)
Сигнальные модули
3.1. DualMA (MA200/MA34)

MA1 (200, TrendTF=H1): тренд-фильтр (вкл/выкл).

MA2 (34 на LOW/HIGH/CLOSE) на текущем ТФ (обычно M15):

Bounce: Long — цена ≤ MA34_low + kATR; Short — цена ≥ MA34_high - kATR.

Break: пробой MA34_close ± kATR.

Вариант STOP: вход моментальный стопом ±StopExtraPts.

Вариант Retest (по умолчанию): ждём откат к MA34_close ± RetestATR.

SL: entry ∓ ATR*mult (направление учитывается).

Защиты:

тренд MA200 может отключить «противо-трендовые» входы,

анти-двойной сигнал на одном баре (__dma_last_bar_time_*).

3.2. Triangle (фракталы)

Берём последние две вершины вверх и вниз (фракталы) на окне поиска.

Строим две трендовые: верхняя/нижняя (линейная).

Режимы:

EDGE_FADE — игра от границы: вход при касании ±ATR-буфер.

BREAKOUT — вход на пробой с опц. STOP.

RETEST — после пробоя «откат к границе + буфер» и лимит-заявка.

SL: entry ∓ ATR*mult.

3.3. Fibo Zone (50–61.8 %)

Определяем последнюю волну A→B (по экстремумам окна).

Если цена в зоне 50–61.8%, направление = знак A→B.

Entry — середина зоны, SL — у 78.6%.

Фильтры качества (перед Triple Screen)

Спред:

жёсткий предел в пунктах (отсев),

статистический: окно N, mean + K*σ.

Торговые часы:

интервалы HH:MM-HH:MM, поддержка ночных окон,

пятница — досрочное завершение.

Новости (CSV):

окна pre/post,

фильтр по валютам символа (base/quote),

минимальная важность (Low/Medium/High).

ATR-процентиль — отсев неликвидных/сонных участков.

Choppiness — отсев флэта при трендовых стратегиях.

ADX — минимальная сила тренда.

Режим рынка — TREND/FLAT (гистерезис), доступен для детальной логики управления.

Triple Screen (Элдер)

Trend (H4): EMA200 + наклон (последние два значения EMA и позиция цены).

Setup (H1): два альтернативных источника сетапа:

DMA34: касание/пробой ±ATR-буферы,

Triangle: EDGE или BREAK/RETEST (через H1 фракталы).

Trigger (M15):

Force Index (EMA, пересечение нуля, знак по тренду — опции),

Envelopes (касание ленты),

режим ANY (хватает одного) или ALL (нужны оба).

Режимы:

HARD — вход разрешён только если (Trend согласован) AND (Setup активен) AND (Trigger подтверждён). Плюс опционально жёсткая блокировка по CCY Bias (headwind запрещён).

SOFT — суммарный скоринг: +Trend +Setup +Trigger -Conflict -Headwind. Порог TS_ScoreThreshold задаёт минимальный балл. Этот скоринг добавляется к базовым весам сигналов в Resolver.

CCY Bias (корзины и headwind)

Для текущего символа S разбираем base/quote.

Считаем силу каждой валюты (средняя нормированная доходность за lookback) по корзине её кроссов.

Delta = S_base - S_quote:

delta > +threshold ⇒ tailwind для Long, headwind для Short,

delta < -threshold ⇒ наоборот.

Применение:

В HARD — опция «жёсткой блокировки» против ветра.

В SOFT — штраф скоринга за headwind.

В Resolver — дополнительный штраф (W_HeadwindPen).

Resolver (анти-спам + выбор лучшего)

Весовые коэффициенты:

W_DMA_Bounce, W_DMA_Retest, W_DMA_Break,

W_TRI_Edge, W_TRI_Retest, W_TRI_Break,

W_FIBO,

W_TS_SoftGain (усиление скоринга Triple Screen),

W_HeadwindPen (штраф за встречный ветер CCY Bias).

Анти-спам: OnePerReasonBar + ReasonCooldownBars (не повторять ту же «причину» в течение N баров).

Результат — один «лучший» SignalCandidate на бар, либо пропуск.
