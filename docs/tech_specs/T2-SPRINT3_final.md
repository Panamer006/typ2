# Техническое Задание (ТЗ) для Задачи: СПРИНТ 3 - Мастерство Торговли по Тренду (Финальная Версия)

## 1. Цель

Реализовать **гибкую, многогранную и настраиваемую систему торговли по тренду**. Это включает создание нескольких трендовых "двигателей", а также финальную доработку "Мозга" (`Resolver`), который будет интеллектуально управлять этими стратегиями, включая обработку контртрендовых сетапов.

## 2. Пошаговый План Реализации

### **Часть А: Трендовые "Двигатели" (`typ_strategies.mqh`)**

#### **Задача 1: Создание Флагманской Стратегии `CStrategy_DualMA_Anchor`**

1.  **Действие:** Создайте/модифицируйте класс `CStrategy_DualMA_Anchor`.
2.  **Действие:** Реализуйте **"Иерархию Скользящих"** и **Динамическую "Сигнальную Зону"**.
3.  **Действие:** Реализуйте генерацию **сигналов-кандидатов** для следующих сетапов:
    *   **"Отскок-Прокол":** Создавайте кандидата, но **добавляйте в его метаданные информацию о цвете "прокольной" свечи**. `Resolver` будет использовать это для выбора сценария входа.
    *   **"Пробой и Закрепление":** Создавайте кандидата после закрытия свечи за "Сигнальной Зоной".
    *   **Четыре Тактики у `SMA 500`:** "Отбой с Подтверждением", "Пробой и Ретест", "Ложный Пробой с Поглощением" и **"Чистый Пробой"**.
    *   **"Слом Локальной Структуры":** Создавайте кандидата при обратном пересечении ценой тактической МА (`EMA 50` или `100`).

#### **Задача 2: Создание Дополнительных Трендовых Стратегий**

1.  **Действие:** Создайте новый класс `CStrategy_DonchianBreakout`.
    *   **Логика:** Генерирует кандидата при пробое Канала Дончиана, добавляя в метаданные **информацию о всплеске объема**.

2.  **Действие:** Создайте новый класс `CStrategy_MA_Cross`.
    *   **Логика:** Генерирует кандидата при пересечении быстрой МА (настраиваемой) и медленной МА (настраиваемой).

### **Часть Б: Финализация "Мозга" (`typ_resolver.mqh`)**

#### **Задача 3: Реализация Гибких Фильтров и Протоколов в `CResolver`**

1.  **Действие:** В `CResolver` добавьте `input`-параметры для управления поведением ключевых фильтров:
    *   `input E_SMA500_Mode InpSMA500Mode = MODE_FULL_TACTICS;` // Enum: DISABLED, FILTER_ONLY, FULL_TACTICS
    *   `input bool InpEnableCounterTrendTrades = true;`
    *   `input double InpCounterTrendRiskModifier = 1.0;` // Модификатор риска для контртренда
    *   `input bool InpEnableSMA500DirectBreakout = false;`

2.  **Действие:** Реализуйте **"Протокол Контртренда"** в методе `Decide()`.
    *   **Логика:** Если кандидат идет против `EMA 200`, но имеет **сверхсильное подтверждение** от фигур ТА Уровня 1 (`CFigures`), не блокируйте его, а примените `InpCounterTrendRiskModifier` к его финальному расчету лота.

#### **Задача 4: Реализация Детализированных Сценариев "Если-То"**

1.  **Действие:** В `CResolver` реализуйте детализированную логику для обработки кандидата **"Отскок-Прокол"**.
    *   **Логика:**
        *   `if (прокольная_свеча_бычья)` -> `TradeOrderInstruction.order_type = ORDER_TYPE_BUY` (вход по рынку).
        *   `if (прокольная_свеча_медвежья)` -> `TradeOrderInstruction.order_type = ORDER_TYPE_BUY_STOP` (установить стоп-ордер над максимумом прокольной свечи).

2.  **Действие:** Реализуйте полную **"Матрицу Конфликтов и Конфлюэнса"**, добавив все 12 утвержденных правил.

### **Часть В: Интеграция в `TakeYourProfit2.mq5`**

1.  **Действие:** Добавьте в `input`-секцию советника все новые параметры для гибкой настройки (`InpSMA500Mode`, `InpCounterTrendRiskModifier` и т.д.).
2.  **Действие:** В `OnInit()` передайте эти параметры в `CResolver`.
3.  **Действие:** В `OnTick()`, в блоке генерации сигналов, убедитесь, что вызываются `FindSignals()` для **всех** новых стратегий (`DualMA`, `Donchian`, `MA_Cross`) в режиме `TREND`.