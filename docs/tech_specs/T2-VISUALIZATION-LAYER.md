# Техническое Задание (ТЗ) для Задачи: T2-VISUALIZATION-LAYER

## 1. Цель

Реализовать "Визуальный Слой" для всех уже созданных модулей Технического Анализа (CPatterns и CFigures). Советник должен уметь в реальном времени отрисовывать на графике все паттерны и фигуры, которые он "видит", в соответствии с утвержденной спецификацией.

## 2. Пошаговый План Реализации

### **Задача 1: Создание Менеджера Объектов (	yp_chart_objects.mqh)**

Чтобы избежать хаоса и мерцания объектов на графике, мы создадим централизованный менеджер.

1.  **Действие:** Создайте новый файл Experts/TYP2/Modules/typ_chart_objects.mqh.
2.  **Действие:** Вставьте в него "скелет" класса CChartObjectsManager.
    *   **Логика:** Этот класс будет отвечать за создание, удаление и обновление всех графических объектов. Он будет хранить список всех созданных им объектов и на каждом тике удалять "старые" (уже неактуальные) и отрисовывать "новые". Это предотвратит дублирование и "мусор" на графике.
    `cpp
    // --- typ_chart_objects.mqh ---
    class CChartObjectsManager {
    private:
        string m_object_prefix; // Уникальный префикс для всех наших объектов
        // ... (список для хранения имен созданных объектов)
    public:
        void Initialize(long chart_id);
        void OnTick(); // Метод для очистки старых объектов
        
        // --- Методы для отрисовки ---
        void DrawLabel(string name, int sub_window, int x, int y, string text, ...);
        void DrawRectangle(string name, int sub_window, datetime time1, double price1, ...);
        void DrawTrendLine(string name, int sub_window, datetime time1, double price1, ...);
        // ... (другие методы для иконок, стрелок и т.д.)
    };
    `

### **Задача 2: Реализация Визуализации в 	yp_patterns.mqh**

1.  **Действие:** Модифицируйте класс CPatterns.
    *   **Что сделать:** Метод DrawPattern должен принимать в качестве аргумента указатель на CChartObjectsManager.
    *   **Как сделать:** oid DrawPattern(CChartObjectsManager* manager, const PatternInfo &info); (где PatternInfo — структура с описанием найденного паттерна).

2.  **Действие:** Реализуйте логику отрисовки для **каждого** из 10 паттернов.
    *   **Пример для "Поглощения":** Метод должен вызвать manager->DrawRectangle(...), чтобы нарисовать полупрозрачную рамку вокруг двух свечей паттерна.
    *   **Пример для "Пин-бара":** Метод должен вызвать manager->DrawIcon(...) (или DrawLabel с кодом иконки), чтобы поставить значок молотка/виселицы под/над хвостом свечи.

### **Задача 3: Реализация Визуализации в 	yp_figures.mqh**

1.  **Действие:** Модифицируйте класс CFigures аналогично CPatterns.
    *   **Что сделать:** Метод DrawFigure должен принимать указатель на CChartObjectsManager.
    *   **Как сделать:** oid DrawFigure(CChartObjectsManager* manager, const FigureInfo &info);

2.  **Действие:** Реализуйте логику отрисовки для **каждой** из 6 фигур.
    *   **Пример для "Головы и Плеч":** Метод должен вызвать manager->DrawTrendLine(...) для отрисовки "Линии Шеи" и manager->DrawLabel(...) для подписи точек "H", "LS", "RS".
    *   **Пример для "Треугольника":** Метод должен вызвать manager->DrawTrendLine(...) дважды для отрисовки границ и, возможно, manager->DrawTriangle(...) для полупрозрачной заливки.

### **Задача 4: Интеграция в TakeYourProfit2.mq5**

1.  **Действие:** Включите #include "Modules/typ_chart_objects.mqh".
2.  **Действие:** Создайте глобальный экземпляр: CChartObjectsManager g_ChartManager;.
3.  **Действие:** В OnInit(), вызовите g_ChartManager.Initialize(ChartID());.
4.  **Действие:** В OnTick(), **в самом начале**, вызовите g_ChartManager.OnTick(); для очистки старых объектов.
5.  **Действие:** В блоке генерации сигналов, после того как модули ТА нашли паттерны, вызовите их отрисовку:
    `cpp
    // --- БЛОК ВИЗУАЛИЗАЦИИ ТА ---
    // (после того как g_Figures и g_Patterns отработали)
    
    // Получаем список найденных фигур
    FigureInfo figures[];
    int count = g_Figures.GetDetectedFigures(figures);
    
    // Отрисовываем каждую
    for(int i=0; i<count; i++) {
        g_Figures.DrawFigure(&g_ChartManager, figures[i]);
    }
    
    // Аналогичная логика для свечных паттернов...
    `
6.  **Действие:** Добавьте input bool ShowPatternsOnChart = true; в начало советника, чтобы пользователь мог включать/отключать всю визуализацию. Блок визуализации должен выполняться только если эта опция включена.
