# Техническое Задание (ТЗ) для Задачи: T2-RISK & T2-005 - Фундамент Безопасности

## 1. Цель

Реализовать **полную, многоуровневую систему безопасности**, наполнив классы `CRiskManager` и `CExecGate` всей необходимой логикой в соответствии с утвержденной спецификацией.

## 2. Пошаговый План Реализации

### **Часть А: `typ_risk.mqh` - Portfolio Risk Manager**

#### **Задача 1: Наполнение Класса `CRiskManager`**

1.  **Действие:** Откройте файл `Experts/TYP2/Modules/typ_risk.mqh`.
2.  **Действие:** Замените пустой "скелет" класса на **полную структуру**, включающую все необходимые `private`-члены (параметры и состояние) и `public`-методы, как мы обсуждали в нашем **утвержденном ТЗ `T2-RISK_Part_A.md`**.

#### **Задача 2: Реализация Глобальных Гвардов**

1.  **Действие:** Реализуйте метод `double GetDailyDDRiskModifier(string &reason)`.
    *   **Логика:** Реализуйте **"Пошаговое Снижение Риска"**: метод возвращает `1.0` (полный риск), `0.5` (половина риска при 50% от лимита DD) или `0.0` (полная блокировка). Также добавьте логику **"Протокола Восстановления"**.
2.  **Действие:** Реализуйте `bool IsCurrencyExposureOK(...)`, `bool IsTotalExposureOK(...)` и `bool IsEOWProtocolActive(...)` в соответствии с ТЗ.

#### **Задача 3: Реализация Контекстных Гвардов**

1.  **Действие:** Реализуйте `void OnTradeClose(...)` для обновления состояния по символам.
2.  **Действие:** Реализуйте **"Адаптивный Cooldown"** в методе `IsCooldownOK(...)`, используя разные таймауты для прибыльных и убыточных сделок.
3.  **Действие:** Реализуйте `bool IsStopLossClusterOK(...)` для защиты от "пилы".

### **Часть Б: `typ_execfilters.mqh` - Фильтры Исполнения**

#### **Задача 4: Наполнение Класса `CExecGate`**

1.  **Действие:** Откройте файл `Experts/TYP2/Modules/typ_execfilters.mqh`.
2.  **Действие:** Замените пустой "скелет" класса на **полную структуру** из утвержденного ТЗ `T2-005_Part_B.md`.

#### **Задача 5: Реализация `NewsGuard`**

1.  **Действие:** Реализуйте метод `void LoadNewsFromCSV(...)` для загрузки новостей.
2.  **Действие:** Реализуйте `bool IsNewsOK(...)` для проверки блокировки.
3.  **Действие:** Реализуйте публичные методы-заглушки `bool IsFlattenRequired(symbol)` и `bool IsQuarantineActive(symbol, direction)`, которые пока будут возвращать `false`.

#### **Задача 6: Реализация Контекстных Гвардов**

1.  **Действие:** Реализуйте **"Динамический Max Spread"** на основе ATR в методе `IsSpreadOK(...)`.
2.  **Действие:** Реализуйте **"Асимметричный Стоп-лосс"** в методе `GetAsymmetricStopLossPips(...)`, который будет возвращать разный размер SL в зависимости от режима `TREND` или `FLAT`.

### **Часть В: Интеграция в `TakeYourProfit2.mq5`**

#### **Задача 7: Финальная Сборка**

1.  **Действие:** В `OnInit()` передайте все необходимые `input`-параметры в `Initialize()` для `CRiskManager` и `CExecGate`.
2.  **Действие:** В `OnTick()` постройте **полную, правильную цепочку проверок**:
    ```cpp
    // --- ПРОВЕРКА ГЛОБАЛЬНЫХ ГВАРДОВ (RISK MANAGER) ---
    string reason;
    double risk_modifier = g_RiskManager.GetRiskModifier(..., reason);
    if (risk_modifier <= 0) {
        // ... (логируем причину и выходим)
        return;
    }

    // ... (здесь блок генерации сигналов, который мы реализуем в Спринте 2) ...
    
    if (signal.isValid) {
        // --- ПРОВЕРКА ГВАРДОВ ИСПОЛНЕНИЯ (EXEC GATE) ---
        if (!g_ExecGate.IsExecutionAllowed(..., reason)) {
            // ... (логируем причину и выходим)
            return;
        }
        
        // --- ФИНАЛЬНЫЙ РАСЧЕТ И ОТПРАВКА ---
        double sl_pips = g_ExecGate.GetAsymmetricStopLossPips(...);
        double base_risk = ... ; // 1.0%
        double final_risk = base_risk * risk_modifier; // Применяем модификатор от DD
        double lot = g_RiskManager.CalculateLotSize(..., final_risk, sl_pips);
        
        // ... (отправка ордера)
    }
    ```