# Take Your Profit 2.0 — Архитектурный Паспорт (Версия 3.2, "Полное Погружение+")

## Часть 1: Философия, Миссия и Ключевые Принципы

### 1.1. Миссия
Создать лучшего торгового советника на рынке MQL5. Это означает систему, которая является не только **потенциально прибыльной**, но и **исключительно надежной, гибкой, адаптивной и прозрачной** в принятии решений. Мы строим не "черный ящик", а профессиональный, отказоустойчивый инструмент для долгосрочной работы.

### 1.2. Ключевые Принципы Архитектуры
- **Модульность:** Система построена из независимых, логически завершенных и заменяемых модулей (`typ_*.mqh`). Каждый модуль имеет одну зону ответственности, что позволяет разрабатывать, тестировать и улучшать его в изоляции.
- **Иерархия ("Принцип Дирижера"):** Ни одна торговая стратегия не имеет прямого доступа к исполнению ордеров. Стратегии действуют как "разведчики", предлагая "сигналы-кандидаты". Центральный **`Resolver` (Оркестратор)** анализирует всю совокупность данных, обогащает их контекстом и принимает **единственное, взвешенное решение**.
- **Безопасность Превыше Всего ("Risk-First"):** Любая торговая логика подчиняется глобальным **"Гвардам"**. Если "Гвард" говорит "нет", торговая активность немедленно прекращается. Безопасность капитала — высший приоритет.
- **Контекстная Адаптивность:** Мы отказываемся от идеи "универсальной" стратегии. Поведение советника кардинально меняется в зависимости от **режима рынка**, который определяется автоматически. Правила для импульса, флэта и консолидации — разные.
- **Data-Driven Подход:** Все решения, от фильтрации до управления риском, основаны на измеряемых, статистически обоснованных данных, а не на субъективных предположениях.

## Часть 2: Техническая Спецификация Модулей

### 2.1. "Мозг" Системы — Уровень Принятия Решений

#### **`Resolver` (Оркестратор)**
- **Задача:** Центральный узел принятия решений. Его цель — предотвратить хаос, выбрать лучший сценарий и рассчитать финальные параметры для сделки.
- **Логика:**
  - **"Матрица Конфликтов и Конфлюэнса":** `Resolver` использует матрицу для оценки взаимодействия сигналов.
    - **Пример Конфлюэнса:** `[DualMA LONG]` + `[Скрытая Дивергенция LONG]` = `score` сигнала `DualMA` **умножается на 1.2**.
    - **Пример Конфликта:** `[Trendline Breakout LONG]` + `[Подход к SMA 500 сверху]` = `score` сигнала **штрафуется на 30 очков**, и активируется требование **дополнительного подтверждения** (например, `WRB`).
  - **Трехуровневая Система Сигналов:**
    - **Категория А ("Королевские Сетапы"):** Макро-структурные паттерны (`MA500_BREAK_CONFIRMED`, "Ночной Пробой с Подтверждением", "Три Экрана для Флэта"). Требуют **1-2 ключевых подтверждения** для немедленного исполнения. **Обоснование:** Эти сигналы настолько сильны, что ожидание множества мелких подтверждений может привести к упущенной выгоде.
    - **Катего-рия Б ("Сигналы Конфлюэнса"):** Основные рабочие сетапы. Требуют набора `score > 80` из множества источников. **Обоснование:** Сигналы этой категории сильны только в комбинации, поэтому мы требуем совпадения нескольких независимых факторов.
    - **Категория С ("Сигналы-Усилители"):** События, влияющие на **уже открытые позиции** (например, активируют "Протокол Ослабевающего Тренда").

#### **`AI-Layer` (Слой Искусственного Интеллекта)**
- **`ML-Gate` ("Историк"):**
  - **Задача:** Оценить историческую вероятность `P(TP1 > SL)`.
  - **Особенности:** Обучается оффлайн на "скользящем окне" свежих данных. Имеет **систему версионирования моделей** для А/Б тестов. **Обоснование:** Позволяет безопасно внедрять новые, потенциально более сильные модели, не останавливая работу текущей.
- **`Bandit` ("Тактик"):**
  - **Задача:** Выбрать лучшую тактику исполнения (пробой, ретест, лимит).
  - **Особенности:** Обучается онлайн. Имеет **"разогрев" на исторических данных**. **Обоснование:** Позволяет роботу быстро адаптироваться к меняющемуся характеру рынка (например, если ретесты перестали работать и начались прямые пробои).
- **`LLM Advisor` ("Стратег"):**
  - **Задача:** Анализировать качественный, нечисловой контекст.
  - **Особенности:** Используется для анализа заявлений ЦБ и новостного фона. **Обоснование:** Добавляет в систему понимание макроэкономического контекста, недоступное для чисто технических индикаторов.

### 2.2. Стратегии и Паттерны

#### **Ночные Стратегии (`T2-STRAT-NIGHT`)**
- **"Динамический Режим Охоты" (`IsInHuntingZone()`):**
  - **Логика:** Торговля разрешена не в фиксированные часы, а только при выполнении условий **"Индекса Спокойствия Рынка"** (комбинация `VIX`, `ADR`, `ATR H1`, `ADX H1`). **Обоснование:** Рынок не всегда спокоен ночью и не всегда активен днем. Этот режим позволяет ловить периоды консолидации в любое время суток, значительно расширяя возможности.
- **`Night MR` (Mean Reversion):**
  - **Тип:** "Сигнал Конфлюэнса".
  - **Логика:** Якорь - касание внешней границы канала Кельтнера на `M15`. `Score` набирается за **`Slope Veto`** (наклон EMA почти нулевой), **Свечные Паттерны** и **Микро-Структуру**.
- **`Night Breakout`:** "Королевский Сетап".
- **"Три Экрана Элдера для Флэта":** "Королевский Сетап".

#### **Дневные Стратеги-и**
- **`Trendline Pro & Channels`:**
  - **Двойные Трендовые:** Отслеживание `base` и `steep` линий. **Обоснование:** Позволяет различать стабильный тренд и его краткосрочное ускорение.
  - **"Морфология Фигур":** Распознавание дочерних фигур (Флаги, Клинья, "Мегафоны").
- **Тактика `SMA 500` ("Гравитационный Центр"):**
  - **Ключевая идея:** `SMA 500` — это не просто МА, это зона, меняющая правила игры.
  - **"Теневой Коридор":** Вокруг `SMA 500` строится коридор `X * ATR` для "мягкого" БУ и идентификации FBO. **Обоснование:** Дает цене "пространство для дыхания" и защищает от ложных выносов стопа при ретестах.
  - **`SequenceRisk`:** Контролируемая эскалация лота (до 5 попыток) при торговле вблизи `SMA 500`. **Обоснование:** Основано на наблюдении, что первый пробой часто бывает ложным, а истинное движение начинается со 2-й или 3-й попытки. Позволяет войти в большое движение, контролируя общий риск на серию.

### 2.3. Управление Позицией и Риск-Менеджмент

- **`Tiered BE` (Ступенчатый Безубыток):**
  - **Логика:** Гибкая система с **разными триггерами** и **"мягким" отрицательным оффсетом**. Тип БУ **напрямую зависит от категории сигнала**. **Обоснование:** Для сильных трендовых сигналов нужен более широкий БУ, чтобы пережить коррекции. Для ночного скальпинга — наоборот, быстрый и жесткий.
- **"Освобождение Риска":** После перевода в БУ, риск **немедленно освобождается**, позволяя открывать новые сделки. **Обоснование:** Фундаментальный принцип нашей стратегии, позволяющий набирать позицию без увеличения риска.
- **"Адаптивная Сетка ТП":** `TP1` (50% объема) -> `BE`, `TP2` (30%), `TP3` ("Раннер"). **Обоснование:** Сочетает надежную фиксацию прибыли с возможностью поймать большое, неожиданное движение.
- **"Флагманский" Сценарий Управления Объемом:** `Resolver` выбирает сценарий входа (1, 2 или 3 ступени) на основе итогового `score`.
- **Гварды:**
  - `EquityGuard` (с сессионным kill-switch), `CurrencyExposureCap`, `Cooldown`, `ParentalLock`.
  - **`ExecGate`:**
    - **`MinSpace`:** Проверка до ближайшего из **всех** барьеров.
    - **"Квантильный `SpreadGuard`":** Блокировка по аномальному спреду для **данного часа суток**. **Обоснование:** Защищает от торговли во время расширения спредов (например, в полночь), но не мешает торговать, если для данного инструмента и часа высокий спред является нормой.

## Часть 3: Состояние Модулей и План Разработки

- **Состояние:** На данный момент мы имеем **чистый, компилируемый каркас** в `dev`-ветке. Все вышеописанные модули существуют в виде **"скелетов" (`.mqh` файлов)**, но их сложная логика еще не реализована.
- **План:** Мы работаем **спринтами** в соответствии с `ROADMAP.md`. Каждый спринт фокусируется на полной реализации и тестировании одного или нескольких связанных модулей.